---

layout: post
title: "从零开始学vim：进阶篇"

---

{% include JB/setup %}

上一篇介绍了vim的基本操作和“vim语言”的基本思想以后，本文继续学习vim系列，两篇加起来vim中最为重要的部分就应该介绍的比较完整了，你也可以开始试着用vim写写脚本之类的，刚开始会很慢，因为每个动作都要想，慢慢练习到后面就可以飞起来了。千万要抵制住按箭头键的冲动！！

本文主要包括翻页与跳转（vim中如何在页面的层级上快速移动？），搜索与替换（如何在全文或者部分位置进行搜索、替换操作？），选中（如何选中文本进行复制粘贴删除？多行同时插入删除字符？），标记与寄存器（如何在文本的任意位置添加标记以快速跳转或者作为其他命令的“动作”使用？），如何使用内置寄存器（暂时存储内容或者与系统剪贴板交互）？

Now let's continue!

<!--more-->

###标记（mark）

vim中允许在文件的任意位置做**标记**，这里标记的意思很简单，就是指给文件中的某个位置用字母做个记号，方便快速跳到这里或者在其他命令中引用。标记指令为`m标记`，26个小写字母可以作为文件内的标记，26个大写字母可以作为全局标记（即可以在文件之间跳转）。例如`ma`将当前光标位置标记为`a`。

标记后即可用以下指令快速跳转到标记位置：

 - `'标记` 跳转到标记所在行
 - `` `标记`` 跳转到标记的确切位置

可以用`:marks`指令查看当前所有的标记，或者`:marks aB`查看一些具体标记的位置。

另外更方便的是标记可当成“动作”使用，还记得上一篇中介绍的动作的概念么？动作可以与指令组合成表示复杂动作的"vim语言"，例如，`d'a`表示从当前位置开始删除直到标记a所在的行。

###寄存器（register）
vim中寄存器的概念也很简单，就是提供暂时存储文本的空间，可以简单的理解为vim中的剪贴板，这些剪贴板中有的是你可以直接使用的普通剪贴板，有的有特殊定义，vim会根据你的自动填充它们的内容。

与标记类似，vim中所有的寄存器都有个用单个字符表示的名字（其实你可以发现vim中很多设计思想都是类似的，最明显的一点就是单字符命名贯穿始终，因为这样按起来快嘛）。寄存器可用`"名字`指代，并且可以与其他动作指令进行结合。例如，`"ay$`表示将当前光标直到行尾的内容复制到寄存器`a`中，`"ap`表示将寄存器`a`中的内容复制到当前光标位置。所以命名寄存器的存在意味着你有了很多个剪贴板。

可以通过`:reg`查看所有寄存器中的内容。另外vim寄存器中的内容是会被写入文件`~/.viminfo`中的，这意味着即使你退出vim再重新进入寄存器中的内容也不会丢失。

vim的寄存器一共可以分为9个类别，下面列出最常用的，全部列表请参考vim的帮助`:help registers`：

 - **命名存储器**：用单个英文字母表示名字，是用户可以随便用的普通剪贴板。
 - **未命名寄存器**：并不是真的未命名，它的名字是`"`，也就是说用`""`可以引用它，其中自动保存最近一次**删除/复制**操作的内容。注意可能你会认为`p`指令会粘贴上一次`y`指令复制的内容（当成ctrl-c和ctrl-v了），其实不然，`p`指令在你不指定任何存储器单独使用的时候实际上是在对默认存储器进行操作，就是说`p`等价于`""p`，也就是说`p`指令其实粘贴的是上一次**删除或者复制**的内容。
 - `0`：自动保存上一次`y`操作的内容，所以到这里就清楚了，如果你在复制过之后做了删除操作，那么必须用`"0p`来粘贴上一次复制的内容，而直接用`p`会粘贴出来你做的最后一次删除操作的内容。
 - `*`：自动保存操作系统剪切版中的内容，用这个你可以把操作系统剪贴板里的东西贴到vim里来


###翻页与跳转
在一般的文本编辑器中想进行快速翻页只有通过page down和page up两个键整页移动，vim中的翻页指令比这丰富的多，包括翻半页，跳转到文件头尾，跳转到当前页面头尾等等，下面给出命令列表：

 - `ctrl-f`（ctrl-forward） page down
 - `ctrl-b`（ctrl-backward）page up
 - `ctrl-d`（ctrl-down）下翻半页
 - `ctrl-u`（ctrl-up）上翻半页
 
 - `gg` 跳转到文件头
 - `G` 跳转到文件尾
 - `行号G` 跳转到行号
 
 - `zz` 将当前光标所在行滚动到窗口中央
 - `zt` 将当前光标所在行滚动到窗口最上方
 - `zb` 将当前光标所在行滚动到窗口最下方
 
另外vim中还有跳转点的概念，每次执行跳转前的位置都会被保存下来，可以通过以下命令在这些跳转位置中快速转换，这样就可以实现跳到某个位置进行编辑然后再快速跳回之类的操作

 - `:jump` 查看所有的跳跃点
 - `ctrl-o` 跳到上一跳跃点
 - `ctrl-i`或`tab` 跳到下一跳跃点
 
值得一提的是跳跃点与寄存器同样是会被保存的，即使退出vim也不会丢失，同时跳跃点也是可以跨文件的，也就是说可以用`ctrl-o`和`ctrl-i`指令在多个文件之间跳转。

###搜索与替换
在vim中搜索超简单，

 - `/pattern` 往前搜索
 - `?pattern` 往后搜索
 
这里pattern是正则表达式，因此当然你搜普通词也是ok的。vim会自动跳转光标到第一个match，然后你可以用

 - `n`跳转到下一个match
 - `N`跳转到上一个match

想想刚才说的跳转点的概念，搜索中每次你跳转都会产生一个新的跳转点，所以你也可以用刚才的跳转点导航命令跳转。

替换指令稍微麻烦一点，它的名字为`:s`，也就是单词substitue的缩写，你可以`:help :s`来查看它的帮助。替换指令的用法是：

 - `:[range]s/patter/string/flag` 

其中，

 - `range` 是可选的，表示执行该替换的范围，最常用的为：
   - 不指定：在当前行替换
   - `%` 在全文中替换
   - `'a,'b` 在标记`a`所在行和标记`b`所在行之间进行替换（两头都是inclusive的）
 - `pattern` 要被替换的查询
 - `string` 替换成的内容
 - `flag` 一些选项
   - `g`（global）全局替换，一般都是要加的，因为如果没有该选项那么每一行只替换第一个查询词
   - `c`（check）替换前确认，替换每一个命中之前让用户手工确认
   - `i`（insensitive）查询时大小写不敏感（默认查询是大小写敏感的）

看起来稍微有点复杂，其实习惯了也很容易，举几个例子：

- `:%s/foo/bar/g` 在整个文件中，将所有foo替换成bar
- `:s/foo/bar/g` 在这一行中将所有foo替换成bar
- `:s/foo/bar` 在这一行中将第一个foo替换成bar
- `:'a,'bs/foo/bar/gci` 在标记a和b之间，将foo替换成bar，大小写不敏感，替换前确认

###选中与块操作
在vim中按一下`v`（表示visual），然后移动光标就可以开始选中了，如果想取消选中模式按`ESC`就可以，事实上在vim中一般情况下如果你不确定自己处于什么状态狂按`ESC`就可以了。

选中之后如果执行操作则都视为对选中文本进行的操作，比如说选中以后按`y`就是复制选中的文本，按`d`就是删除选中的文本，换句话说选中可以看成以可视化的方式构造一个**对象**，然后根据前面说的vim语言很多的动作都可以在该对象上执行。

另外还有两种常用的选中模式：

 - `shift-v` 行选中，这个试试就知道是啥意思了
 - `ctrl-v` 块选中，这个模式很有趣，可以让选中一个矩形块，最容易明白的方式也是试一下

通过块选中模式显然可以进行例如**删除连续多行之前的空格**之类的操作，（因为你可以选中这些连续行前的空格组成的矩形块，然后按`d`）。如果要在**连续多行之前插入**则要稍微复杂一点，首先在你想插入的位置按`ctrl-v`并用块选中模式选中所有你想要插入的行（一般是在第一行上开始`ctrl-v`然后`j`），选好后按下`shift-i`进入块编辑模式，然后输入内容，然后按`ESC`，搞定！


### Anything else?

到这里差不多vim的基本操作都已经有了，不过不幸的告诉你这大概只是vim的1％而已（其实lz会的也就这些了。。），日常写写脚本查查日志什么的应该还是足够，多多练习才是王道！后面或许还会写一篇介绍几个常用的vim插件来将vim打造成一个ide（关于插件也可以参考[这一篇](http://blog.jobbole.com/51564/)）。另外如果要想真的**grok vim**请阅读这个[vim大神在stackoverflow上的答案](https://gist.github.com/nifl/1178878)先，然后就是多用`:help`了，里面信息量超大。